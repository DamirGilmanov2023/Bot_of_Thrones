import cv2 as cv
import numpy as np
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.actions.action_builder import ActionBuilder
from selenium.webdriver.common.action_chains import ActionChains
import time

t=input('Введите задержку между действиями в секундах=')
t=int(t)

def driver_btn(cls,num):
    time.sleep(2)
    flag = True
    while flag:
        try:
            btn=driver.find_elements(By.CLASS_NAME, str(cls))[num]
            btn.click()
            flag = False
        except:
            time.sleep(1)
def driver_inp(cls,num,keys):
    time.sleep(2)
    flag = True
    while flag:
        try:
            inp=driver.find_elements(By.CLASS_NAME, str(cls))[num]
            inp.send_keys(keys)
            flag = False
        except:
            time.sleep(1)

def bool_loc(num_sh,threshold):
    img_rgb = cv.imread('screen.png')
    dim=(1584,837)
    resized = cv.resize(img_rgb, dim, interpolation = cv.INTER_AREA)
    img_gray = cv.cvtColor(resized, cv.COLOR_BGR2GRAY)
    template = cv.imread(f'img/{num_sh}.png',0)
    res = cv.matchTemplate(img_gray,template,cv.TM_CCOEFF_NORMED)
    loc = np.where( res >= threshold)
    if np.size(loc[0])!=0:
        return True
    else:
        return False

def click(gx,gy):
    global driver,flag_59
    if flag_59:
        go_step2('59_',1110,88,0.6)
    print('Клик')
    action = ActionBuilder(driver)
    action.pointer_action.move_to_location(int(gx),int(gy))
    time.sleep(t/2)
    action.perform()
    time.sleep(t/2+1)
    ActionChains(driver).click().perform()

def clickf(gx,gy):
    global driver
    print('Клик')
    action = ActionBuilder(driver)
    action.pointer_action.move_to_location(int(gx),int(gy))
    time.sleep(t/3)
    action.perform()
    time.sleep(t/3)
    ActionChains(driver).click().perform()

flag_59=True
def go_step(img_num,gx,gy,threshold = 0.4):
    global driver,flag_59
    time.sleep(t)
    flag=True
    print(f'Изо {img_num}')
    if flag_59:
        go_step2('59_',1110,88,0.6)
    '''if img_num!=1 and img_num!=4:
        go_step2(40,630,110,0.6)'''
    while flag:
        driver.save_screenshot('screen.png')
        if bool_loc(img_num,threshold):
            clickf(gx,gy)
            flag=False
        else:
            if flag_59:
                go_step2('59_',1110,88,0.6)
            '''if img_num!=1 and img_num!=4:
                go_step2(40,630,110,0.6)'''
            time.sleep(1)

def go_step2(img_num,gx,gy,threshold = 0.4):
    global driver,flag_59
    #time.sleep(2)
    print(f'Подпроверка Изо {img_num}')
    driver.save_screenshot('screen.png')
    if bool_loc(img_num,threshold):
        clickf(gx,gy)
        if img_num=='59_':
            flag_59=False
    else:
        time.sleep(1)

def go_step104(img_num,gx,gy,threshold=0.4):
    global driver
    time.sleep(5)
    flag=True
    print(f'Изо {img_num}')
    while flag:
        driver.save_screenshot('screen.png')
        if bool_loc(img_num,threshold):
            clickf(gx,gy)
            flag=False
        elif bool_loc('104_',threshold):
            clickf(gx,gy)
            go_step(101,555,375)
            go_step(102,900,555)
            go_step(103,950,590)
        else:
            time.sleep(1)

emails = open('mail.txt', 'r').read().split('\n')

for mail in emails:

    driver = webdriver.Chrome(executable_path="chromedriver.exe")
    driver.set_window_size(1280, 800)
    driver.implicitly_wait(20)

    driver.get('https://101xp.com/games/')
    driver_btn('btn-green-bordered',0)
    driver_btn('btn-primary',11)
    driver_inp('popup-input',0,f"{mail}")
    nic = mail.split('@')
    driver_inp('popup-input',1,f"{nic[0]}2022")
    driver_inp('popup-input',2,f"{nic[0]}2022")
    driver_btn('ng-star-inserted',10)
    time.sleep(8)
    driver.get('https://101xp.com/games/game_of_thrones/play')
    time.sleep(8)
    driver.execute_script("document.getElementsByClassName('header-game')[0].style.display='none';")

    print('Засыпаем на минуту')
    time.sleep(60)
    go_step(1,620,228)
    go_step(1,620,228)
    go_step(3,835,448)
    go_step(4,620,228)
    go_step(1,620,228)
    go_step(1,620,228)
    go_step(4,620,228)
    go_step(1,620,228)
    go_step(6,540,380)
    go_step(7,530,566)
    go_step(7,530,566)
    go_step(1,635,235)
    go_step(1,635,235)
    go_step(8,1220,99)
    go_step(9,616,363)
    go_step(10,956,603)
    go_step(1,635,235)
    go_step(11,645,368)
    go_step(12,950,600)
    go_step(1,635,235)
    time.sleep(5)
    click(630,350)
    go_step(14,635,120)
    go_step(15,340,420)
    time.sleep(5)
    click(940,600)
    go_step(17,950,590)
    go_step(18,757,210)
    go_step(19,632,595)
    go_step(20,1150,295)
    go_step(21,980,220)
    go_step(1,635,235)
    go_step(21,980,220)
    go_step(1,635,235)
    go_step(22,640,340)
    go_step(23,960,600)
    go_step(24,630,590)
    go_step(25,1150,280)
    go_step(21,980,218)
    go_step(21,980,218)
    go_step(26,540,590)
    go_step(1,635,235)
    go_step(27,640,600)
    time.sleep(5)
    click(885,230)
    time.sleep(5)
    click(900,420)
    go_step(4,620,228)
    go_step(4,620,228)
    time.sleep(5)
    click(640,600)
    time.sleep(5)
    click(520,200)
    time.sleep(5)
    click(580,269)
    go_step(1,620,228)
    time.sleep(5)
    click(460,340)
    time.sleep(3)
    click(940,540)
    time.sleep(5)
    click(940,586)
    time.sleep(5)
    go_step(28,640,540)
    go_step(1,620,228)
    go_step(1,620,228)
    go_step(29,630,480)
    go_step(30,444,238)
    time.sleep(5)
    click(796,602)
    go_step(1,620,228)
    time.sleep(5)
    click(1160,296)
    go_step(21,980,218)
    go_step(21,980,218)
    go_step(1,620,228)
    go_step(21,990,580)
    go_step(1,620,228)
    go_step(6,540,336)
    go_step(7,530,566)
    go_step(1,620,228)
    go_step(31,1220,99)
    time.sleep(5)
    click(1150,300)
    go_step(32,980,222)
    go_step(33,630,350)
    go_step(23,960,600)
    go_step(34,630,590)
    go_step(1,620,228)
    go_step(35,625,350)
    go_step(36,800,600)
    go_step(1,620,228)
    go_step(37,1150,280)
    go_step(38,980,220)
    go_step(39,630,500)
    #go_step(40,630,110)
    go_step(41,1034,116)
    go_step(38,980,220)
    go_step(42,630,210)
    go_step(42,630,210)
    go_step(43,630,210)
    go_step(44,640,245)
    go_step(44,640,245)
    go_step(45,1140,300)
    go_step(38,980,220)
    go_step(46,616,340)
    go_step(47,797,119)
    go_step(1,620,228)
    go_step(48,974,600)
    go_step(41,1034,116)
    go_step(49,1140,300)
    go_step(38,980,220)
    go_step(38,980,220)
    go_step(50,644,346)
    go_step(1,620,228)
    go_step(51,790,600)
    go_step(52,1140,300)
    go_step(38,980,220)
    go_step(39,630,560)
    go_step(38,980,220)
    go_step(53,640,350)
    go_step(54,625,117)
    go_step(55,700,430)
    go_step(1,620,228)
    go_step(55,1009,185)
    go_step(56,630,560)
    go_step(55,950,600)
    go_step(55,950,600)
    go_step(57,760,210)
    go_step(58,630,595)
    go_step(41,1034,116)
    go_step(59,1140,300)
    #go_step('59_',1110,88)
    go_step(38,980,220)
    go_step(38,980,220)
    time.sleep(5)
    click(630,380)
    go_step(60,635,600)
    go_step(61,635,600)
    time.sleep(5)
    click(580,270)
    time.sleep(5)
    click(933,588)
    time.sleep(5)
    go_step(62,643,533)
    go_step(63,1140,300)
    go_step(38,980,220)
    go_step(38,977,582)
    go_step(1,620,228)
    go_step(1,620,228)
    go_step(6,540,380)
    go_step(7,530,566)
    go_step(64,1220,99)
    go_step(1,620,228)
    go_step(37,1150,280)
    go_step(65,980,220)
    go_step(1,620,228)
    #Союз
    time.sleep(5)
    click(967,613)
    go_step(1,620,228)
    go_step(1,620,228)
    go_step(66,720,450)
    time.sleep(5)
    click(582,600)
    go_step(1,620,228)
    time.sleep(5)
    click(1030,100)
    go_step(68,1140,300)
    go_step(65,980,220)
    go_step(69,630,360)
    go_step(70,950,600)
    go_step(71,630,590)
    go_step(41,1034,116)
    go_step(72,620,340)
    time.sleep(30)
    go_step(73,588,599)
    time.sleep(5)
    click(640,340)
    time.sleep(15)
    go_step(74,1000,500,0.6)
    go_step(75,320,414)
    go_step(76,900,550)
    go_step(77,950,595)
    time.sleep(15)
    go_step(78,1000,500,0.6)
    go_step(1,620,228)
    go_step(79,1220,600)
    go_step(80,300,280)
    go_step(81,1177,168)
    go_step(82,930,320)
    go_step(83,730,600)
    go_step(84,1237,80)
    go_step(85,1033,115)
    go_step(86,360,350)
    go_step(87,900,550)
    go_step(88,900,550)
    time.sleep(40)
    go_step(89,1000,500,0.6)
    go_step(90,600,200)
    go_step(91,1225,95)
    go_step(1,620,228)
    time.sleep(5)
    click(905,610)
    go_step(1,620,228)
    time.sleep(5)
    click(632,285)
    time.sleep(5)
    click(1015,600)
    time.sleep(5)
    click(730,600)
    time.sleep(5)
    click(1084,600)
    go_step(119,1120,200)
    go_step(120,1235,84)
    go_step(1,620,228)
    go_step(121,1070,195)
    go_step(1,620,228)
    time.sleep(5)
    click(1122,104)
    time.sleep(5)
    click(840,604)
    go_step(91,425,258)
    go_step(92,895,550)
    go_step(1,620,228)
    go_step(93,385,590)
    time.sleep(3)
    click(971,227)
    go_step(94,955,590)
    go_step(95,1225,225)
    go_step(96,1040,500,0.6)
    go_step(97,500,290)
    go_step(98,900,540)
    go_step(99,950,595)
    go_step(100,1040,500,0.6)
    go_step(101,555,375)
    go_step(102,900,555)
    go_step(103,330,590)
    time.sleep(1)
    click(390,600)
    time.sleep(1)
    click(444,589)
    time.sleep(1)
    click(330,590)
    time.sleep(1)
    click(390,600)
    time.sleep(1)
    click(444,589)
    time.sleep(1)
    click(950,590)
    go_step104(104,1040,500,0.6)
    go_step(105,650,560)
    go_step(106,500,450)
    go_step(107,880,550)
    go_step(108,500,600)
    time.sleep(1)
    click(945,600)
    go_step(109,1040,500,0.6)
    go_step(110,613,498)
    go_step(111,900,555)
    go_step(112,950,590)
    go_step(113,1220,175)
    go_step(114,1000,500,0.6)
    go_step(115,1220,95)
    '''go_step(1,620,228)
    time.sleep(3)
    click(900,610)
    go_step(1,620,228)
    time.sleep(3)
    click(630,280)
    go_step(116,1010,610)
    go_step(117,730,600)
    go_step(118,1090,610)
    go_step(119,1120,200)
    go_step(120,1235,84)
    go_step(1,620,228)
    go_step(121,1070,195)
    go_step(1,620,228)
    go_step(122,1122,97)'''
    go_step(123,1140,300)
    go_step(65,980,220)
    go_step(124,625,560)
    go_step(65,980,220)
    go_step(65,980,220)
    go_step(65,980,220)
    go_step(125,650,360)
    go_step(126,630,120)
    go_step(127,530,420)
    go_step(128,950,600)
    time.sleep(3)
    click(950,600)
    go_step(129,755,210)
    go_step(130,630,600)
    go_step(131,1033,116)
    go_step(132,1140,290)
    go_step(65,980,220)
    go_step(124,625,560)
    go_step(65,980,220)
    time.sleep(3)
    click(662,345)
    go_step(133,638,600)
    go_step(134,630,600)
    time.sleep(3)
    click(580,270)
    time.sleep(3)
    click(935,588)
    time.sleep(5)
    go_step(135,630,540)
    time.sleep(5)
    go_step(136,1137,294)
    go_step(65,980,220)
    go_step(65,975,583)
    go_step(1,620,228)
    go_step(1,620,228)
    go_step(6,540,380)
    go_step(7,530,566)
    go_step(7,530,566)
    go_step(1,620,228)
    go_step(4,620,228)
    go_step(4,620,228)
    go_step(1,620,228)
    time.sleep(3)
    click(1216,94)
    time.sleep(3)
    click(540,380)
    time.sleep(3)
    click(1216,94)
    go_step(1,620,228)
    time.sleep(3)
    click(963,616)
    go_step(137,962,334)
    time.sleep(3)
    click(962,334)
    time.sleep(3)
    click(1030,116)
    time.sleep(5)
    go_step(138,1150,300)
    go_step(139,978,220)
    go_step(124,625,560)
    go_step(139,978,220)
    time.sleep(3)
    click(630,340)
    go_step(140,955,600)
    go_step(141,615,600)
    go_step(140,1035,118)
    go_step(1,620,228)
    time.sleep(5)
    click(636,360)
    go_step(142,800,600)
    go_step(143,1150,300)
    go_step(139,978,220)
    go_step(139,978,220)
    time.sleep(5)
    click(650,360)
    go_step(144,630,120)
    go_step(145,550,200)
    time.sleep(5)
    click(700,395)
    go_step(145,953,607)
    go_step(145,953,607)
    go_step(146,760,210)
    go_step(147,636,598)
    #go_step(148,760,210)
    #go_step(149,633,595)
    go_step(150,1033,118)
    go_step(151,1135,300)
    go_step(139,978,220)
    go_step(139,978,220)
    time.sleep(5)
    click(630,260)
    go_step(152,950,606)
    go_step(152,950,606)
    go_step(152,810,120)
    go_step(1,620,228)
    time.sleep(5)
    click(368,238)
    go_step(1,620,228)
    go_step(1,620,228)
    time.sleep(5)
    click(440,255)
    go_step(153,636,565)
    time.sleep(5)
    click(851,140)
    time.sleep(5)
    click(1030,99)
    time.sleep(5)
    click(1036,117)
    time.sleep(5)
    go_step(160,1080,306)
    go_step(161,972,219)
    time.sleep(5)
    click(658,394)
    time.sleep(5)
    click(980,220)
    time.sleep(5)
    click(650,390)
    go_step(162,638,600)
    go_step(162,638,600)
    go_step(163,585,275)
    time.sleep(5)
    click(940,589)
    time.sleep(5)
    go_step(135,630,540)
    go_step(164,1100,295)
    go_step(161,972,219)
    go_step(161,978,582)
    go_step(1,620,228)
    go_step(165,1100,295)
    time.sleep(5)
    go_step(161,972,219)
    time.sleep(5)
    click(642,275)
    go_step(166,999,407)
    go_step(167,800,600)
    go_step(167,950,600)
    go_step(167,950,600)
    go_step(167,950,600)
    go_step(167,999,400)
    go_step(166,950,600)
    go_step(166,950,600)
    go_step(166,950,600)
    time.sleep(5)
    click(687,195)
    time.sleep(5)
    click(1032,118)
    time.sleep(5)
    click(758,209)
    time.sleep(5)
    click(630,605)
    go_step('besp',690,200,0.6)
    go_step(168,650,570)
    time.sleep(5)
    click(1017,161)
    go_step(166,1034,117)
    time.sleep(5)
    click(1035,125)
    go_step(1,620,228)
    time.sleep(5)
    click(972,610)
    go_step(169,1046,100)
    go_step(1,620,228)
    time.sleep(5)
    click(632,352)
    #go_step(1,620,228)
    go_step(170,800,120)
    time.sleep(5)
    click(364,325)
    #go_step(1,620,228)
    go_step(171,1035,95)
    time.sleep(5)
    click(1035,118)
    go_step(172,1024,183)
    go_step(173,1100,295)
    go_step(161,972,219)
    go_step(124,625,560)
    go_step(161,972,219)
    time.sleep(5)
    click(640,340)
    go_step(174,635,117)
    time.sleep(5)
    click(548,203)
    time.sleep(5)
    click(345,396)
    go_step(175,950,604)
    time.sleep(5)
    click(950,600)
    time.sleep(5)
    click(758,208)
    go_step(176,636,595)
    #go_step(177,980,140)
    time.sleep(5)
    click(980,140)
    time.sleep(5)
    click(633,123)
    go_step(178,917,419)
    go_step(179,950,600)
    time.sleep(5)
    click(950,600)
    time.sleep(5)
    click(750,207)
    time.sleep(5)
    click(640,590)
    time.sleep(5)
    click(1032,118)
    go_step(181,1100,295)
    go_step(161,972,219)
    go_step(161,972,285)
    time.sleep(5)
    click(700,400)
    go_step(182,638,600)
    go_step(183,638,600)
    go_step(184,583,270)
    time.sleep(5)
    click(940,580)
    time.sleep(5)
    go_step(135,630,540)
    time.sleep(5)
    click(700,400)
    go_step(182,638,600)
    #go_step(183,638,600)
    go_step(184,583,270)
    time.sleep(5)
    click(940,580)
    time.sleep(5)
    go_step(135,630,540)
    go_step(185,1100,295)
    time.sleep(5)
    click(636,120)
    time.sleep(3)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(960,435)
    time.sleep(2)
    click(1030,115)
    go_step(185,1100,295)
    go_step(161,972,222)
    go_step(161,972,222)
    driver.quit()
